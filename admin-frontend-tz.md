# ТЗ фронта: админка EASSP (Ant Design 6)

Документ описывает требования к фронтенду админ-панели. Бэкенд API описан в `docs/admin-frontend-api.md` и обязателен к соблюдению.

---

## 0) Цель и объем

Цель: сделать современную, удобную и понятную админку для управления пользователями, ролями/возможностями, справочниками и номенклатурой (база знаний).

В объем входят:
- Авторизация и сессии.
- Управление пользователями.
- Управление возможностями (abilities) и матрицей доступов по ролям.
- База знаний: номенклатура и справочники.
- Глобальные состояния: ошибки, загрузка, пустые списки, пагинация.

Вне объема:
- Создание/редактирование ролей (в API отсутствует). Роли только читаются и используются в матрице доступов.
- Все прочие модули (TRU, план закупок, файлы) если явно не указаны.

---

## 1) Технологические требования

- React + TypeScript.
- UI библиотека: Ant Design v6 (обязательно).
- Роутинг: React Router.
- Работа с API: Axios или fetch с единым HTTP-клиентом и интерсепторами.
- Работа с серверным состоянием: React Query (рекомендовано) или аналог.
- Локализация: UI на русском языке, даты в формате ru-RU.

---

## 2) Архитектура интерфейса

### 2.1 Базовый макет
- `Layout` с `Sider` (меню), `Header` (профиль, выход), `Content`.
- `Sider` collapsible на узких экранах.
- `Breadcrumb` в верхней части контента.
- Страницы должны быть читаемыми при ширине 1280+ и корректно скроллиться на 768+.

### 2.2 Навигация
Меню (минимум):
- Пользователи
- Доступы (Роли и Возможности)
  - Роли (список, read-only)
  - Возможности (список и редактирование)
  - Матрица доступов
- База знаний
  - Номенклатура
  - Справочники

Опционально: раздел "Профиль" (выпадающее меню в Header).

### 2.3 Состояния
- Loading: skeleton/спиннер, таблица не дергается при обновлении фильтров.
- Empty: понятный empty state с пояснением.
- Error: единый компонент ошибки с текстом и кнопкой "Повторить".

---

## 3) Авторизация и сессия

### 3.1 Логика сессий
- После логина сохранять `accessToken` в памяти приложения.
- При перезагрузке страницы выполнять `POST /auth/refresh` (cookie) для восстановления `accessToken`.
- `deviceId` генерируется один раз (UUID) и хранится в localStorage.

### 3.2 Обработка 401
- При `401 ACCESS_TOKEN_INVALID`/`TOKEN_REVOKED` выполнить refresh (один раз).
- Если refresh неуспешен → редирект на login и очистка сессии.
- Нельзя запускать несколько refresh параллельно (очередь/лок).

### 3.3 Права доступа
- После входа получить `/auth/me` и использовать `abilities` для управления видимостью меню/кнопок.
- Если доступ к странице отсутствует → показать 403 экран.

---

## 4) UI/UX требования

- Визуально легкий интерфейс, светлая тема, аккуратные отступы, четкие таблицы.
- Статусы выделять цветными `Tag` или `Badge`.
- Везде использовать понятные названия полей, подсказки (tooltips), примеры форматов.
- Формы в Drawer/Modal (не отдельные страницы), чтобы сохранять контекст.
- При любом успешном действии показывать `message.success`.
- При ошибке показывать `notification.error` с понятным текстом.

---

## 5) Функциональные требования по модулям

### 5.1 Страница входа
**Экран:**
- Поля: email, password.
- Кнопка "Войти".
- Ошибки валидации (email формат, пустые поля).
- При ошибке `INVALID_CREDENTIALS` показать текст "Неверный логин или пароль".
- При `USER_INACTIVE` показать "Пользователь заблокирован".

API:
- `POST /auth/login`

---

### 5.2 Пользователи

#### 5.2.1 Список пользователей
**Таблица:**
- Email
- ФИО (LastName FirstName MiddleName)
- Роль
- Должность
- Статус (active/inactive)
- Последний вход
- Создан
- Действия

**Фильтры:**
- Search (по email и ФИО)
- Роль (select)
- Должность (select)
- Статус

**Действия (row):**
- Просмотр (drawer)
- Редактировать профиль
- Сменить роль
- Сменить должность
- Сменить пароль
- Заблокировать/разблокировать

API:
- `GET /users`
- `GET /users/:id`

#### 5.2.2 Создание пользователя
**Форма:**
- email (обязательное)
- firstName (обязательное)
- lastName (обязательное)
- middleName (опционально)
- roleId (обязательное, select)
- positionId (обязательное, select)
- password (обязательное, min 8 символов)
- isActive (toggle, default true)

**Поведение:**
- Роли брать из `GET /access/roles` и фильтровать по isActive.
- Должности брать из `GET /dictionaries/positions`.
- Ошибка `USER_EMAIL_EXISTS` привязывается к полю email.

API:
- `POST /users`

#### 5.2.3 Редактирование пользователя
**Форма:**
- firstName, lastName, middleName, email.

**Поведение:**
- Если нет изменений — кнопка "Сохранить" неактивна.
- Ошибка `USER_EMAIL_EXISTS` → email.

API:
- `PATCH /users/:id`

#### 5.2.4 Смена роли
- Отдельный drawer/modal с выбором роли.
- Ошибки `ROLE_NOT_FOUND`/`ROLE_INACTIVE` отображаются рядом с select.

API:
- `PATCH /users/:id/role`

#### 5.2.5 Смена должности
- Отдельный drawer/modal с выбором должности.
- Ошибка `POSITION_NOT_FOUND`.

API:
- `PATCH /users/:id/position`

#### 5.2.6 Смена пароля
- Поле `password` + подтверждение.

API:
- `PATCH /users/:id/password`

#### 5.2.7 Блокировка
- Кнопка "Заблокировать/Разблокировать".
- Подтверждение через `Modal.confirm`.

API:
- `PATCH /users/:id/status`

---

### 5.3 Доступы (Роли и Возможности)

#### 5.3.1 Список ролей (read-only)
**Таблица:**
- code
- name
- description
- isActive

API:
- `GET /access/roles`

#### 5.3.2 Каталог возможностей
**Таблица:**
- code
- name
- category
- description
- isActive
- createdAt

**Фильтры:**
- search (code/name)
- category (select)
- isActive

**Действия:**
- Создать возможность
- Редактировать возможность
- Включить/выключить (если нужно)

API:
- `GET /access/abilities`
- `POST /access/abilities`
- `PATCH /access/abilities/:id`

#### 5.3.3 Матрица возможностей по ролям
**Цель:** быстро настраивать доступы ролей.

**UI:**
- Слева список ролей (выбор одной роли).
- Справа список возможностей, сгруппированных по `category`.
- У каждой способности чекбокс включения.
- Кнопки: "Сохранить", "Сбросить".
- Индикатор несохраненных изменений.

**Алгоритм сохранения:**
- Получить текущий список возможностей роли (`GET /access/roles/:code/abilities`).
- Сравнить с UI и вычислить:
  - `toAdd` → отправить `POST /access/roles/:code/abilities`.
  - `toRemove` → отправить `DELETE /access/roles/:code/abilities`.
- После успешной операции обновить данные.

**Ошибки:**
- `ABILITY_NOT_FOUND` → показать список недоступных кодов.
- `ABILITY_INACTIVE` → показать предупреждение.

---

### 5.4 База знаний

#### 5.4.1 Номенклатура
**Таблица:**
- id
- name
- okeiCode
- vdCode
- createdAt

**Фильтры:**
- search (по name/id)
- OKEI code (select из `okei-units`)
- VD code (select из `vd-codes`)

**Действия:**
- Создать (если есть `nomenclature.create`)

**Форма создания:**
- id (опционально)
- name (обязательное)
- okeiCode (обязательное)
- vd_code (опционально)

API:
- `GET /nomenclature-items`
- `POST /nomenclature-items`

---

#### 5.4.2 Справочники
**Концепция:** единый универсальный CRUD для всех словарей.

**Навигация:**
- Список словарей слева или табами.
- При выборе словаря загрузить список записей.

**Таблица:**
- Показывать ключевые поля в зависимости от словаря.
- Всегда показывать `id` или `code` (в зависимости от `entryIdField`).
- Показывать `isActive` если поле присутствует.

**Фильтры:**
- Использовать только те, которые разрешены для данного словаря (см. `admin-frontend-api.md`).

**Форма создания/редактирования:**
- Динамически показывать поля на основе конфигурации словаря.
- Обязательные поля выделять.
- Для `branchOfficeId`, `departmentId`, `categoryId`, `parentId` использовать Select с поиском.

**Удаление:**
- Всегда подтверждать удаление.
- Если `softDelete=true`, помечать запись как неактивную (UI может показывать статус).

API:
- `GET /dictionaries/:dictionary`
- `GET /dictionaries/:dictionary/:entryId`
- `POST /dictionaries/:dictionary`
- `PATCH /dictionaries/:dictionary/:entryId`
- `DELETE /dictionaries/:dictionary/:entryId`

---

## 6) Обработка ошибок и сообщений

Глобально:
- Все ошибки показывать пользователю с понятным текстом.
- Поддержать расшифровку ключевых кодов ошибок (см. `docs/admin-frontend-api.md`).

Примеры:
- `USER_EMAIL_EXISTS` → "Email уже используется".
- `ROLE_NOT_FOUND` → "Роль не найдена".
- `DICTIONARY_FIELD_NOT_ALLOWED` → "Поле недоступно для этого справочника".

---

## 7) Компоненты (рекомендуемые)

- `AppLayout` (Layout + Sider + Header)
- `PageHeader` (Title + Actions + Breadcrumb)
- `DataTable` (таблица с серверной пагинацией)
- `FiltersPanel` (форма фильтров с reset)
- `EntityDrawerForm` (создание/редактирование в drawer)
- `ConfirmModal` (подтверждения)
- `RoleAbilityMatrix` (матрица доступов)

---

## 8) Нефункциональные требования

- Производительность: запросы только по необходимости, debounce для search.
- UX: состояние загрузки не должно блокировать весь экран (локальные спиннеры).
- Доступность: управление с клавиатуры, фокус в модалках, aria-label.
- Безопасность: не сохранять refresh token в localStorage.

---

## 9) Критерии приемки

- Все страницы работают в соответствии с API контрактом.
- UI корректно обрабатывает все указанные коды ошибок.
- Реализована матрица доступов по ролям.
- Реализованы CRUD для пользователей и справочников.
- Ант дизайн v6 используется везде (без сторонних UI-библиотек).
- Приложение корректно работает при обновлении страницы и разлогинивается при истечении сессии.

